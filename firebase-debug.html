<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Debug Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .button {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    .button:hover {
      background-color: #3367d6;
    }
    .code-block {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .instructions {
      background-color: #e8f0fe;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <h1>Firebase Debug Tool</h1>
  
  <div class="instructions">
    <h2>Instructions</h2>
    <p>This tool helps diagnose Firebase connection issues in production. Follow these steps:</p>
    <ol>
      <li>Copy the debug script below</li>
      <li>Open your production site in Chrome</li>
      <li>Open Chrome DevTools (F12 or Right-click > Inspect)</li>
      <li>Go to the Console tab</li>
      <li>Paste the script and press Enter</li>
      <li>Check the detailed debug report in the console</li>
    </ol>
  </div>
  
  <h2>Debug Script</h2>
  <p>Copy this entire script:</p>
  
  <div class="code-block">
    <button class="button" onclick="copyScript()">Copy Script</button>
    <pre id="script-content">/**
 * Firebase Debug Console Script
 * 
 * This is a standalone script that can be pasted directly into the browser console
 * to debug Firebase connection issues in production.
 */

(async function() {
  console.group('ðŸ” Firebase Debug Report');
  
  // Environment information
  console.log('Environment Information:');
  console.log('- Current URL:', window.location.href);
  console.log('- Hostname:', window.location.hostname);
  console.log('- Protocol:', window.location.protocol);
  console.log('- User Agent:', navigator.userAgent);
  
  // Get Firebase app
  const app = window.firebase?.app?.() || 
              window.firebase?.apps?.[0] || 
              window._firebase_app || 
              null;
  
  if (!app) {
    console.error('âŒ Could not find Firebase app instance');
    console.log('Attempting to fix WebChannel connection issues directly...');
    
    // Try to fix WebChannel issues even without direct access to Firebase
    try {
      // Find Firestore instance in window
      const firestoreKeys = Object.keys(window).filter(key => 
        key.includes('firebase') || 
        key.includes('Firestore') || 
        key.includes('firestore') ||
        key.includes('db')
      );
      
      console.log('Potential Firestore keys:', firestoreKeys);
      
      // Try to modify settings on any potential Firestore instances
      firestoreKeys.forEach(key => {
        try {
          const instance = window[key];
          if (instance && typeof instance === 'object') {
            if (instance._settings) {
              console.log(`Found potential Firestore instance at window.${key}`);
              instance._settings.host = 'firestore.googleapis.com';
              instance._settings.ssl = true;
              console.log(`Modified settings for window.${key}`);
            }
          }
        } catch (e) {
          // Ignore errors
        }
      });
      
      // Try to find Firebase in other common locations
      if (window.firebase) {
        console.log('Found firebase in window.firebase');
        if (window.firebase.firestore) {
          const settings = {
            experimentalForceLongPolling: true,
            ssl: true,
            host: 'firestore.googleapis.com'
          };
          window.firebase.firestore().settings(settings);
          console.log('Applied settings to window.firebase.firestore()');
        }
      }
    } catch (e) {
      console.error('Failed to fix WebChannel issues:', e);
    }
    
    console.log('Manual Fix Instructions:');
    console.log(`
    // Add this to your firebase.ts file:
    
    // For production, use these settings:
    db = initializeFirestore(app, {
      experimentalForceLongPolling: true,
      ssl: true,
      ignoreUndefinedProperties: true
    });
    
    // Then apply this workaround:
    // @ts-ignore
    db._settings = {
      ...db._settings,
      host: 'firestore.googleapis.com',
      ssl: true
    };
    `);
    
    console.groupEnd();
    return;
  }
  
  console.log('Firebase App Info:', {
    name: app.name,
    options: {
      projectId: app.options.projectId,
      authDomain: app.options.authDomain
    }
  });
  
  // Try to get Firestore instance
  let db;
  try {
    // Try different ways to access Firestore
    db = window.db || 
         window.firestore || 
         window.firebase?.firestore?.() || 
         app.firestore?.();
    
    if (!db) {
      console.warn('Could not find Firestore instance directly');
      // Try to create a new one
      const firebase = window.firebase;
      if (firebase && firebase.firestore) {
        db = firebase.firestore();
        console.log('Created new Firestore instance');
      }
    }
  } catch (e) {
    console.error('Error accessing Firestore:', e);
  }
  
  if (db) {
    console.log('Found Firestore instance');
    
    // Try to fix WebChannel connection issues
    try {
      console.log('Attempting to fix WebChannel connection issues...');
      
      // Apply settings to fix WebChannel issues
      const settings = {
        experimentalForceLongPolling: true,
        ssl: true,
        host: 'firestore.googleapis.com'
      };
      
      // Try different ways to apply settings
      if (db.settings) {
        db.settings(settings);
        console.log('Applied settings via db.settings()');
      }
      
      // Try to access internal settings
      if (db._settings) {
        db._settings = {
          ...db._settings,
          host: 'firestore.googleapis.com',
          ssl: true
        };
        console.log('Applied settings via db._settings');
      }
      
      console.log('WebChannel connection issues should be fixed');
      console.log('Refresh the page and try again');
    } catch (e) {
      console.error('Failed to fix WebChannel issues:', e);
    }
  } else {
    console.error('Could not find or create Firestore instance');
  }
  
  // Network diagnostics
  console.log('Network Diagnostics:');
  console.log('- Online Status:', navigator.onLine ? 'Online' : 'Offline');
  
  // Check for CORS issues
  console.log('Testing CORS Configuration...');
  try {
    const projectId = app?.options?.projectId || 
                     window.FIREBASE_PROJECT_ID || 
                     prompt('Enter your Firebase Project ID:');
    
    if (projectId) {
      const response = await fetch(`https://${projectId}.firebaseio.com/.json?shallow=true`);
      console.log('- CORS Test Status:', response.status);
      console.log('- CORS Test OK:', response.ok);
    } else {
      console.warn('Could not determine Firebase Project ID for CORS test');
    }
  } catch (error) {
    console.error('- CORS Test Failed:', error);
  }
  
  console.groupEnd();
  
  return 'Firebase debug complete. Check console for detailed report.';
})();</pre>
  </div>
  
  <h2>Permanent Fix</h2>
  <p>To permanently fix the WebChannel connection issue, add this code to your firebase.ts file:</p>
  
  <div class="code-block">
    <button class="button" onclick="copyFix()">Copy Fix</button>
    <pre id="fix-content">// For production, use these settings:
db = initializeFirestore(app, {
  experimentalForceLongPolling: true,
  ssl: true,
  ignoreUndefinedProperties: true
});

// Then apply this workaround:
// @ts-ignore
db._settings = {
  ...db._settings,
  host: 'firestore.googleapis.com',
  ssl: true
};</pre>
  </div>
  
  <script>
    function copyScript() {
      const scriptContent = document.getElementById('script-content').textContent;
      navigator.clipboard.writeText(scriptContent)
        .then(() => alert('Debug script copied to clipboard!'))
        .catch(err => console.error('Failed to copy: ', err));
    }
    
    function copyFix() {
      const fixContent = document.getElementById('fix-content').textContent;
      navigator.clipboard.writeText(fixContent)
        .then(() => alert('Fix code copied to clipboard!'))
        .catch(err => console.error('Failed to copy: ', err));
    }
  </script>
</body>
</html> 